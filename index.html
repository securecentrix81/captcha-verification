<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Captcha Verification</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }

    .captcha-container {
      background: white;
      border: 2px solid #d3d3d3;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      max-width: 400px;
      width: 100%;
      transform: scale(1.3);
      text-align: center;
    }

    .captcha-header {
      margin-bottom: 15px;
      font-size: 18px;
      font-weight: bold;
      color: #333;
    }

    .captcha-iframe {
      width: 100%;
      height: 300px;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-bottom: 15px;
    }

    .verify-button {
      width: calc(100% - 50px);
      padding: 12px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s;
      display:inline;
      margin: 0;
    }

    .verify-button:hover {
        background-color: #45a049;
    }

    .verify-button:active {
      background-color: #3d8b40;
    }
    
    .verify-button.disabled {
      background-color: rgb(143.57,143.57,143.57);
      cursor: not-allowed;
    }
    #errormessage {
      white-space: pre-wrap;
      padding: 8px;
      color: #f00;
    }
    .buttonContainer {
      width: 100%;
      padding: 0;
      display: block;
    }
    .reload-button {
      margin: 0;
      display: inline;
      vertical-align: bottom;
      border-radius: 10000px;
      padding: 5px;
      cursor: pointer;
    }
    #iframe-container {
      width: 100%; 
      height: 300px;
      display: flex;
      justify-content: center;
      align-items: center;
    }
  </style>
</head>
<body>
  <script>Q1927356128374=true;addEventListener("error",(e)=>{if(Q1927356128374){Q1927356128374=false;alert(e.message)}})</script>
    <div class="captcha-container">
      <div class="captcha-header">
        Please verify you are human
      </div>
      <div id="iframe-container" style="width: 100%; height: 300px; text-align: center">
      <iframe id="captcha-frame" class="captcha-iframe" allow="fullscreen" sandbox="allow-scripts allow-same-origin allow-modals allow-pointer-lock"></iframe>
      </div>
      <pre id="errormessage"></pre>
      <div class="buttonContainer">
        <button class="verify-button disabled" id="verify-btn">Verify</button><div id="regenerate-btn" title="Regenerate Captcha" class="reload-button" style="display:inline-block;padding:0;background-color:#eee;">
          <svg class="reload-button" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="44" height="44" viewBox="0 0 30 30"><path d="M 15 3 C 12.031398 3 9.3028202 4.0834384 7.2070312 5.875 A 1.0001 1.0001 0 1 0 8.5058594 7.3945312 C 10.25407 5.9000929 12.516602 5 15 5 C 20.19656 5 24.450989 8.9379267 24.951172 14 L 22 14 L 26 20 L 30 14 L 26.949219 14 C 26.437925 7.8516588 21.277839 3 15 3 z M 4 10 L 0 16 L 3.0507812 16 C 3.562075 22.148341 8.7221607 27 15 27 C 17.968602 27 20.69718 25.916562 22.792969 24.125 A 1.0001 1.0001 0 1 0 21.494141 22.605469 C 19.74593 24.099907 17.483398 25 15 25 C 9.80344 25 5.5490109 21.062074 5.0488281 16 L 8 16 L 4 10 z"></path></svg>
        </div>
      </div>
    </div>
    
    <script>
      let validCaptchas = [
        {
          weight: 1,
          data: [
            {
              weight: 1,
              data: "typing-test-1"
            },
            {
              weight: 1,
              data: "typing-test-2"
            }
          ]
        }, 
        {
          weight: 0.9,
          data: "no-mouse-1"
        },
        {
          weight: 0.9,
          data: "clicker-1"
        },
        {
          weight: 1,
          data: "selectAllPixels-1"
        },
        {
          weight: 0.9,
          data: "logarithmic-1"
        },
        {
          weight: 1,
          data: "ambiguous-answer-1"
        },
        {
          weight: 1,
          data: "enterIP-1"
        },
        {
          weight: 1.2,
          data: [
            {
              weight: 1,
              data: "escapeRoom-1"
            },
            {
              weight: 1,
              data: "escapeRoom-2"
            }
          ]
        },
        {
          weight: 1,
          data: "guess-1"
        },
        {
          weight: 0.9,
          data: "flipcoin-1"
        },
        {
          weight: 1.2,
          data: "tic-tac-toe-1"
        },
        {
          weight: 1.1,
          data: "reaction-1"
        }, 
        {
          weight: 1.4,
          data: "platformer-1"
        },
        {
          weight: 1.4,
          data: "riggedplinko-1"
        },
        {
          weight: 1.1,
          data: "guess-2"
        },
        {
          weight: 0.9,
          data: "click-1"
        },
        {
          weight: 0.9,
          data: "proof-1"
        },
      ]
      let verifybtn = document.getElementById('verify-btn')
      let regeneratebtn = document.getElementById('regenerate-btn')
      let errormessage = document.getElementById('errormessage')
      
      let onverify = () => {}
      let intervals = []
      let timeouts = []
      window.addEventListener("message", (e) => {
        let data = e.data
        if (data.type === "clear_error") {errormessage.innerText = ""}
        if (data.type === "error_message") {errormessage.innerText = data.message}
        if (data.type === "typing-test-1" || data.type === "typing-test-2") {
          if (data.pass) {
            verifybtn.classList.remove("disabled")
            onverify = () => {
              if (!verifybtn.classList.contains("disabled")) {
                errormessage.innerText = "An error occurred\nLoading new captcha..."
                verifybtn.classList.add("disabled")
                timeouts.push(setTimeout(() => {
                  loadIframeContent()
                },1000))
              }
            }
          }
        }
        if (data.type === "selectAllPixels-1") {
          verifybtn.classList.remove("disabled")
          errormessage.innerText = ""
          onverify = () => {
            errormessage.innerText = ""
            let returnMessage = `${data.wrong} pixels are wrong\n`
            if (data.remove > 0) {
              returnMessage += `You need to erase ${data.remove} pixels\n`
            }
            if (data.add > 0) {
              returnMessage += `You need to add ${data.add} pixels\n`
            }
            if (data.wrong > 0) {
              errormessage.innerText = returnMessage
            } else {
              errormessage.innerText = "1 pixels are wrong\nYou need to erase 1 pixels"
            }
          }
        }
        if (data.type === "ambiguous-answer-1") {
          verifybtn.classList.remove("disabled")
          onverify = () => {
            errormessage.innerText = "The person is spinning to the " + (data.selection === "left" ? "right" : "left") + "\nLoading new captcha..."
            verifybtn.classList.add("disabled")
            timeouts.push(setTimeout(() => {
              loadIframeContent()
            },1000))
          }
        }
        if (data.type === "enterIP-1") {
          verifybtn.classList.remove("disabled")
          onverify = () => {
            errormessage.innerText = ""
            if (!(/^(25[0-5]|2[0-4]\d|1?\d?\d)(\.(25[0-5]|2[0-4]\d|1?\d?\d)){3}$/).test(data.text)) {
              errormessage.innerText = "That's not your IP"
              return
            }
            if (data.ip === false) {
              errormessage.innerText = "Uploading IP to hacker..."
              timeouts.push(setTimeout(() => {
                errormessage.innerText = "Uploading IP to hacker...\nHey thanks for your IP!\nAs a reward, we will give you another captcha."
                timeouts.push(setTimeout(() => {
                  loadIframeContent()
                },2000))
              },1000))
            } else {
              if (data.text !== data.ip) {
                errormessage.innerText = "That's not your IP"
              } else {
                errormessage.innerText = "Uploading IP to hacker..."
                timeouts.push(setTimeout(() => {
                  errormessage.innerText = "Uploading IP to hacker...\nHey thanks for your IP!\nAs a reward, we will give you another captcha."
                  timeouts.push(setTimeout(() => {
                    loadIframeContent()
                  },2000))
                },1000))
              }
            }
          }
        }
        if (data.type === "escapeRoom-1" || data.type === "escapeRoom-2") {
          if (data.ended) {
            errormessage.innerHTML = "0:00:00\nTime's up. Regenerating captcha..."
            timeouts.push(setTimeout(() => {
              loadIframeContent()
            },1000))
          } else {
            let intervalID = setInterval(() => {
              let time = 60000-(Date.now()-data.start)
              if (time <= 0) {
                clearInterval(intervalID)
                return
              }
              let seconds = Math.floor(time/1000)
              if (seconds.toString().length === 1) seconds = "0" + seconds.toString()
              let miliseconds = time%1000
              while (miliseconds.toString().length < 3) {miliseconds = "0" + miliseconds.toString()}
              errormessage.innerHTML = `<span style="color:#000">0:${seconds}:${miliseconds}</span>`
            })
            intervals.push(intervalID)
          }
        }
        if (data.type === "flipcoin-1") {
          if (data.spinStart) {
            errormessage.innerText = ""
          } else {
            errormessage.innerText = `Coin did not land on heads. ${10-data.attempts}/10 attempts remaining.`
            if (data.attempts >= 10) {
              errormessage.innerText += `\nOut of attempts. Reloading captcha...`
              timeouts.push(setTimout(() => {
                loadIframeContent
              }, 1000))
            }
          }
        }
        if (data.type === "riggedplinko-1") {
          if (data.restart) errormessage.innerText = ""
          if (data.computerGain != null) {
            errormessage.innerText = `Computer gained ${data.computerGain===0?"no":data.computerGain} point${data.computerGain===1?"":"s"}!`
          }
          if (data.playerGain != null) {
            errormessage.innerText = `You gained ${data.playerGain===0?"no":data.playerGain} point${data.playerGain===1?"":"s"}!`
          }
          if (data.ended) {
            errormessage.innerText = `Computer won by ${data.computerScore-data.playerScore} points!\nWin the game to pass the captcha`
          }
        }
        if (data.type === "platformer-1") {
          errormessage.innerText = data.message
          errormessage.style = "font-size: 9px"
        }
        if (data.type === "guess-2") {
          errormessage.innerText = "The number was " + data.number + ". Click \"Try again\" to try again."
        }
      })
      function getIframeURL() {
        let captchaFile = validCaptchas[Math.floor(Math.random()*validCaptchas.length)]
        while (typeof captchaFile === "object") {
          captchaFile = captchaFile[Math.floor(Math.random()*captchaFile.length)]
        }
        return {type:captchaFile,html:HtmlService.createHtmlOutputFromFile(captchaFile).getContent()};
      }
      function getRandomCaptcha(captchas) {
        if (typeof captchas !== "object") return captchas
        let totalWeights = 0
        for (let weight of captchas) {
          totalWeights += weight.weight
        }
        let selectedWeight = totalWeights*Math.random()
        let currentWeight = 0
        for (let weight of captchas) {
          currentWeight += weight.weight
          if (currentWeight >= selectedWeight) {
            weight.weight /= 1.2
            return getRandomCaptcha(weight.data)
          }
        }
        alert("An error occurred. This should not happen. Actually, there is no way this can even happen. Why are you reading this? Thanks for wasting your time reading this message.")
      }
      function loadIframeContent() {
        document.getElementById('captcha-frame').src = `data:text/html,<style>body,html{height:100%;margin:0}body{display:grid;place-items:center}h1{margin:0}</style><h1>Loading Captcha...</h1>`
        verifybtn.classList.add("disabled")
        for (let i of timeouts) clearTimeout(i)
        for (let i of intervals) clearInterval(i)
        timeouts = false
        intervals = false // any intervals called before loading will error
        errormessage.innerText = ""
        errormessage.style = ""
        onverify = () => {}
        
        let iframeURL = getRandomCaptcha(validCaptchas)
        if (iframeURL === "platformer-1") {
          document.getElementById("captcha-frame").style = "height: 100%; width: auto; aspect-ratio:1"
        } else if (iframeURL === "riggedplinko-1") {
          document.getElementById("captcha-frame").style = "height: 500px; width: auto; aspect-ratio:1;transform: scale(0.6)"
        } else if (iframeURL === "proof-1") {
          verifybtn.classList.remove("disabled")
          onverify = () => {
            errormessage.innerHTML = "Your answer is incorrect. Tips to correct your answer: <ol><li>Check over your work</li><li>Explain your work</li><li>Stay on topic</li></ol>"
          }
        } else {
          document.getElementById("captcha-frame").style = "width: 100%; height: 300px"
        }
        timeouts = []
        intervals = []
        document.getElementById("captcha-frame").src = iframeURL + ".html"
      }
      verifybtn.addEventListener("click", (e) => {
        onverify()
      })
      regeneratebtn.addEventListener("click", (e) => {
        loadIframeContent()
      })
      
      loadIframeContent()
    </script>
  </body>
</html>
